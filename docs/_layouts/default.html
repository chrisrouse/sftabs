<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>{{ page.title }} | {{ site.title }}</title>
    <meta name="description" content="{{ page.description | default: site.description }}">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}">

    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="{{ '/' | relative_url }}" style="text-decoration: none !important;">
                <img src="{{ '/assets/images/invert.png' | relative_url }}" alt="SF Tabs Logo" class="navbar-logo me-2">
                <strong>SF Tabs</strong>
                <span class="badge bg-warning text-dark ms-2" style="font-size: 0.8rem; vertical-align: middle;">Pre-release</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link{% if page.url == '/' %} active{% endif %}" href="{{ '/' | relative_url }}">
                            <i class="bi bi-house-fill me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if page.url contains 'installation' %} active{% endif %}" href="{{ '/installation' | relative_url }}">
                            <i class="bi bi-download me-1"></i>Installation
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if page.url contains 'new-features' %} active{% endif %}" href="{{ '/new-features' | relative_url }}">
                            <i class="bi bi-stars me-1"></i>New Features
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if page.url contains 'user-guide' %} active{% endif %}" href="{{ '/user-guide' | relative_url }}">
                            <i class="bi bi-book-fill me-1"></i>User Guide
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/chrisrouse/sftabs" target="_blank">
                            <i class="bi bi-github me-1"></i>GitHub
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar (only on documentation pages) -->
            {% if page.url != '/' %}
            <aside class="col-lg-3 col-xl-2 d-none d-lg-block sidebar">
                <div class="sidebar-sticky">
                    <h6 class="sidebar-heading">User Guide</h6>

                    <!-- Search Bar -->
                    <div class="sidebar-search">
                        <div class="search-input-wrapper">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="sidebarSearch" class="form-control" placeholder="Search guide..." autocomplete="off">
                            <button id="clearSearch" class="clear-search" style="display: none;">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        </div>
                        <div id="searchSuggestions" class="search-suggestions" style="display: none;"></div>
                    </div>

                    <!-- Getting Started -->
                    <div class="sidebar-section">
                        <a class="sidebar-toggle" data-bs-toggle="collapse" href="#gettingStarted" role="button" aria-expanded="true">
                            <i class="bi bi-chevron-down me-1"></i>Getting Started
                        </a>
                        <div class="collapse show" id="gettingStarted">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#opening-the-extension' | relative_url }}">Opening the Extension</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#adding-a-new-tab' | relative_url }}">Adding a New Tab</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#tab-types' | relative_url }}">Tab Types</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Dropdown Menus -->
                    <div class="sidebar-section">
                        <a class="sidebar-toggle" data-bs-toggle="collapse" href="#dropdownMenus" role="button" aria-expanded="false">
                            <i class="bi bi-chevron-right me-1"></i>Dropdown Menus
                        </a>
                        <div class="collapse" id="dropdownMenus">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#creating-dropdown-menus' | relative_url }}">Creating Dropdowns</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#object-manager-dropdowns-automatic' | relative_url }}">Object Manager Dropdowns</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#manual-dropdowns-drag-and-drop' | relative_url }}">Manual Dropdowns</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#folder-style-tabs-menu-containers' | relative_url }}">Folder-Style Tabs</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Managing Tabs -->
                    <div class="sidebar-section">
                        <a class="sidebar-toggle" data-bs-toggle="collapse" href="#managingTabs" role="button" aria-expanded="false">
                            <i class="bi bi-chevron-right me-1"></i>Managing Tabs
                        </a>
                        <div class="collapse" id="managingTabs">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#editing-tabs' | relative_url }}">Editing Tabs</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#reordering-tabs' | relative_url }}">Reordering Tabs</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#deleting-tabs' | relative_url }}">Deleting Tabs</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Keyboard Shortcuts -->
                    <div class="sidebar-section">
                        <a class="sidebar-toggle" data-bs-toggle="collapse" href="#keyboardShortcuts" role="button" aria-expanded="false">
                            <i class="bi bi-chevron-right me-1"></i>Keyboard Shortcuts
                        </a>
                        <div class="collapse" id="keyboardShortcuts">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#keyboard-shortcuts' | relative_url }}">Overview</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#setting-up-shortcuts-in-firefox' | relative_url }}">Firefox Setup</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#setting-up-shortcuts-in-chrome' | relative_url }}">Chrome Setup</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="sidebar-section">
                        <a class="sidebar-toggle" data-bs-toggle="collapse" href="#settings" role="button" aria-expanded="false">
                            <i class="bi bi-chevron-right me-1"></i>Settings
                        </a>
                        <div class="collapse" id="settings">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#settings' | relative_url }}">Settings Overview</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#appearance' | relative_url }}">Appearance</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#behavior' | relative_url }}">Behavior</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#sync--storage' | relative_url }}">Sync & Storage</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Profiles -->
                    <div class="sidebar-section">
                        <a class="sidebar-toggle" data-bs-toggle="collapse" href="#profiles" role="button" aria-expanded="false">
                            <i class="bi bi-chevron-right me-1"></i>Profiles
                        </a>
                        <div class="collapse" id="profiles">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#profiles' | relative_url }}">Profiles Overview</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#enabling-profiles' | relative_url }}">Enabling Profiles</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#creating-a-new-profile' | relative_url }}">Creating Profiles</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#switching-between-profiles' | relative_url }}">Switching Profiles</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#managing-profiles' | relative_url }}">Managing Profiles</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Import/Export -->
                    <div class="sidebar-section">
                        <a class="sidebar-toggle" data-bs-toggle="collapse" href="#importExport" role="button" aria-expanded="false">
                            <i class="bi bi-chevron-right me-1"></i>Import/Export
                        </a>
                        <div class="collapse" id="importExport">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#importexport-configuration' | relative_url }}">Import/Export Overview</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#export-configuration' | relative_url }}">Export Configuration</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#import-configuration' | relative_url }}">Import Configuration</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Upgrading -->
                    <div class="sidebar-section">
                        <a class="sidebar-toggle" data-bs-toggle="collapse" href="#upgrading" role="button" aria-expanded="false">
                            <i class="bi bi-chevron-right me-1"></i>Upgrading to v2.0
                        </a>
                        <div class="collapse" id="upgrading">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#upgrading-to-v200-migration-wizard' | relative_url }}">Migration Wizard</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#whats-being-migrated' | relative_url }}">What's Being Migrated</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/user-guide#after-migration' | relative_url }}">After Migration</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Troubleshooting -->
                    <div class="sidebar-section">
                        <a class="nav-link" href="{{ '/user-guide#troubleshooting' | relative_url }}">
                            <i class="bi bi-wrench me-2"></i>Troubleshooting
                        </a>
                    </div>                    
            </aside>
            {% endif %}

            <!-- Main content area -->
            <main class="{% if page.url != '/' %}col-lg-9 col-xl-10 ms-sm-auto{% else %}col-12{% endif %} px-md-4 main-content">
                <div class="content-wrapper">
                    {{ content }}
                </div>

                <!-- Footer -->
                <footer class="footer mt-5 py-4">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="text-muted mb-0">
                                    Â© {{ 'now' | date: "%Y" }} SF Tabs. Open source project.
                                </p>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <a href="https://github.com/chrisrouse/sftabs" class="text-muted text-decoration-none me-3" target="_blank">
                                    <i class="bi bi-github"></i> GitHub
                                </a>
                                <a href="https://github.com/chrisrouse/sftabs/issues" class="text-muted text-decoration-none" target="_blank">
                                    <i class="bi bi-bug"></i> Issues
                                </a>
                            </div>
                        </div>
                    </div>
                </footer>
            </main>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

    <!-- Sidebar collapse toggle -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle sidebar toggle chevron icons
            const toggles = document.querySelectorAll('.sidebar-toggle');
            toggles.forEach(toggle => {
                const target = toggle.getAttribute('href');
                const collapseElement = document.querySelector(target);

                if (collapseElement) {
                    collapseElement.addEventListener('show.bs.collapse', function() {
                        const icon = toggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('bi-chevron-right');
                            icon.classList.add('bi-chevron-down');
                        }
                    });

                    collapseElement.addEventListener('hide.bs.collapse', function() {
                        const icon = toggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('bi-chevron-down');
                            icon.classList.add('bi-chevron-right');
                        }
                    });
                }
            });

            // Search functionality
            const searchInput = document.getElementById('sidebarSearch');
            const clearButton = document.getElementById('clearSearch');
            const suggestionsContainer = document.getElementById('searchSuggestions');
            const sidebarSections = document.querySelectorAll('.sidebar-section');
            const contentWrapper = document.querySelector('.content-wrapper');

            if (!searchInput) return;

            let searchTimeout;
            let contentIndex = [];

            // Build search index from content
            function buildContentIndex() {
                if (!contentWrapper) return;

                const headings = contentWrapper.querySelectorAll('h2, h3, h4');
                headings.forEach(heading => {
                    const id = heading.id;
                    const text = heading.textContent.trim();
                    let preview = '';

                    // Get preview text from next elements
                    let nextElement = heading.nextElementSibling;
                    while (nextElement && preview.length < 150) {
                        if (nextElement.tagName.match(/^H[2-6]$/)) break;
                        if (nextElement.textContent) {
                            preview += nextElement.textContent.trim() + ' ';
                        }
                        nextElement = nextElement.nextElementSibling;
                    }

                    contentIndex.push({
                        id: id,
                        title: text,
                        preview: preview.substring(0, 150).trim() + '...',
                        element: heading
                    });
                });
            }

            buildContentIndex();

            // Debounce function
            function debounce(func, wait) {
                return function executedFunction(...args) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => func(...args), wait);
                };
            }

            // Highlight text matches
            function highlightText(text, query) {
                if (!query) return text;
                const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
                return text.replace(regex, '<span class="search-suggestion-highlight">$1</span>');
            }

            // Escape regex special characters
            function escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // Filter sidebar TOC
            function filterSidebar(query) {
                if (!query) {
                    sidebarSections.forEach(section => {
                        section.classList.remove('search-hidden');
                    });
                    return;
                }

                const lowerQuery = query.toLowerCase();
                sidebarSections.forEach(section => {
                    const toggleText = section.querySelector('.sidebar-toggle')?.textContent.toLowerCase() || '';
                    const links = section.querySelectorAll('.nav-link');
                    let hasMatch = toggleText.includes(lowerQuery);

                    links.forEach(link => {
                        const linkText = link.textContent.toLowerCase();
                        if (linkText.includes(lowerQuery)) {
                            hasMatch = true;
                        }
                    });

                    if (hasMatch) {
                        section.classList.remove('search-hidden');
                        // Expand matching sections
                        const collapse = section.querySelector('.collapse');
                        if (collapse && !collapse.classList.contains('show')) {
                            const bsCollapse = new bootstrap.Collapse(collapse, { toggle: true });
                        }
                    } else {
                        section.classList.add('search-hidden');
                    }
                });
            }

            // Show search suggestions
            function showSuggestions(query) {
                if (!query || query.length < 2) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                const lowerQuery = query.toLowerCase();
                const matches = contentIndex.filter(item =>
                    item.title.toLowerCase().includes(lowerQuery) ||
                    item.preview.toLowerCase().includes(lowerQuery)
                ).slice(0, 8); // Limit to 8 suggestions

                if (matches.length === 0) {
                    suggestionsContainer.innerHTML = '<div class="no-results">No results found</div>';
                    suggestionsContainer.style.display = 'block';
                    return;
                }

                const html = matches.map(item => `
                    <div class="search-suggestion-item" data-id="${item.id}">
                        <div class="search-suggestion-title">${highlightText(item.title, query)}</div>
                        <div class="search-suggestion-preview">${highlightText(item.preview, query)}</div>
                    </div>
                `).join('');

                suggestionsContainer.innerHTML = html;
                suggestionsContainer.style.display = 'block';

                // Add click handlers
                suggestionsContainer.querySelectorAll('.search-suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        if (id) {
                            window.location.hash = id;
                            searchInput.value = '';
                            clearSearch();
                        }
                    });
                });
            }

            // Handle search input
            const handleSearch = debounce(function(e) {
                const query = e.target.value.trim();

                if (query) {
                    clearButton.style.display = 'block';
                } else {
                    clearButton.style.display = 'none';
                }

                filterSidebar(query);
                showSuggestions(query);
            }, 300);

            searchInput.addEventListener('input', handleSearch);

            // Clear search
            function clearSearch() {
                searchInput.value = '';
                clearButton.style.display = 'none';
                suggestionsContainer.style.display = 'none';
                filterSidebar('');
            }

            clearButton.addEventListener('click', clearSearch);

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });

            // Handle escape key
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    clearSearch();
                }
            });
        });
    </script>
</body>
</html>
