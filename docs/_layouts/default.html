<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>{{ page.title }} | {{ site.title }}</title>
    <meta name="description" content="{{ page.description | default: site.description }}">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}">

    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="{{ '/' | relative_url }}" style="text-decoration: none !important;">
                <img src="{{ '/assets/images/invert.png' | relative_url }}" alt="SF Tabs Logo" class="navbar-logo me-2">
                <strong>SF Tabs</strong>
                <span class="badge bg-warning text-dark ms-2" style="font-size: 0.8rem; vertical-align: middle;">Pre-release</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link{% if page.url == '/' %} active{% endif %}" href="{{ '/' | relative_url }}">
                            <i class="bi bi-house-fill me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if page.url contains 'installation' %} active{% endif %}" href="{{ '/installation' | relative_url }}">
                            <i class="bi bi-download me-1"></i>Installation
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if page.url contains 'new-features' %} active{% endif %}" href="{{ '/new-features' | relative_url }}">
                            <i class="bi bi-stars me-1"></i>New Features
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if page.url contains 'user-guide' %} active{% endif %}" href="{{ '/user-guide' | relative_url }}">
                            <i class="bi bi-book-fill me-1"></i>User Guide
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/chrisrouse/sftabs" target="_blank">
                            <i class="bi bi-github me-1"></i>GitHub
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        {% if page.url != '/' %}
        <!-- Mobile Menu Button (only visible on mobile for doc pages) -->
        <div class="container-fluid d-lg-none border-top" style="background-color: #c2deff; border-color: rgba(0,0,0,0.1) !important;">
            <button class="btn btn-outline-dark btn-sm my-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileNav" aria-controls="mobileNav">
                <i class="bi bi-list"></i> Menu
            </button>
        </div>
        {% endif %}
    </nav>

    <!-- Mobile Navigation (only on documentation pages) -->
    {% if page.url != '/' %}
    <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="mobileNav" aria-labelledby="mobileNavLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="mobileNavLabel">User Guide</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="mobile-sidebar-nav">
                <!-- Search Bar -->
                <div class="mobile-search mb-3">
                    <div class="search-input-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" id="mobileSidebarSearch" class="form-control" placeholder="Search guide..." autocomplete="off">
                        <button id="mobileClearSearch" class="clear-search" style="display: none;">
                            <i class="bi bi-x-circle-fill"></i>
                        </button>
                    </div>
                    <div id="mobileSearchSuggestions" class="search-suggestions" style="display: none;"></div>
                </div>

                <!-- Navigation Sections -->
                <div class="mobile-nav-sections">
                    <!-- Getting Started -->
                    <div class="mobile-nav-section">
                        <a class="mobile-nav-toggle" data-bs-toggle="collapse" href="#mobileGettingStarted">
                            <i class="bi bi-chevron-right me-1"></i><i class="bi bi-rocket-takeoff me-2"></i>Getting Started
                        </a>
                        <div class="collapse" id="mobileGettingStarted">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/getting-started#opening-the-extension' | relative_url }}">Opening the Extension</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/getting-started#adding-a-new-tab' | relative_url }}">Adding a New Tab</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/getting-started#tab-types' | relative_url }}">Tab Types</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Managing Tabs -->
                    <div class="mobile-nav-section">
                        <a class="mobile-nav-toggle" data-bs-toggle="collapse" href="#mobileManagingTabs">
                            <i class="bi bi-chevron-right me-1"></i><i class="bi bi-pencil-square me-2"></i>Managing Tabs
                        </a>
                        <div class="collapse" id="mobileManagingTabs">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#editing-tabs' | relative_url }}">Editing Tabs</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#reordering-tabs' | relative_url }}">Reordering Tabs</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#open-in-new-tab' | relative_url }}">Open in New Tab</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#deleting-tabs' | relative_url }}">Deleting Tabs</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#creating-dropdown-menus' | relative_url }}">Creating Dropdown Menus</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#floating-button' | relative_url }}">Floating Button</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Keyboard Shortcuts -->
                    <div class="mobile-nav-section">
                        <a class="mobile-nav-toggle" data-bs-toggle="collapse" href="#mobileKeyboardShortcuts">
                            <i class="bi bi-chevron-right me-1"></i><i class="bi bi-keyboard me-2"></i>Keyboard Shortcuts
                        </a>
                        <div class="collapse" id="mobileKeyboardShortcuts">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/keyboard-shortcuts#setting-up-shortcuts-in-firefox' | relative_url }}">Setting Up Shortcuts in Firefox</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/keyboard-shortcuts#setting-up-shortcuts-in-chrome' | relative_url }}">Setting Up Shortcuts in Chrome</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="mobile-nav-section">
                        <a class="mobile-nav-toggle" data-bs-toggle="collapse" href="#mobileSettings">
                            <i class="bi bi-chevron-right me-1"></i><i class="bi bi-gear me-2"></i>Settings
                        </a>
                        <div class="collapse" id="mobileSettings">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/settings#general' | relative_url }}">General</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/settings#floating-button' | relative_url }}">Floating Button</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/settings#keyboard-shortcuts' | relative_url }}">Keyboard Shortcuts</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/settings#data' | relative_url }}">Data</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/settings#import-export-configuration' | relative_url }}">Import/Export Configuration</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Profiles -->
                    <div class="mobile-nav-section">
                        <a class="mobile-nav-toggle" data-bs-toggle="collapse" href="#mobileProfiles">
                            <i class="bi bi-chevron-right me-1"></i><i class="bi bi-person-badge me-2"></i>Profiles
                        </a>
                        <div class="collapse" id="mobileProfiles">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/profiles#enabling-profiles' | relative_url }}">Enabling Profiles</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/profiles#creating-a-profile' | relative_url }}">Creating a Profile</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/profiles#switching-profiles' | relative_url }}">Switching Profiles</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/profiles#managing-profiles' | relative_url }}">Managing Profiles</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/profiles#best-practices' | relative_url }}">Best Practices</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/profiles#disabling-profiles' | relative_url }}">Disabling Profiles</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Upgrading -->
                    <div class="mobile-nav-section">
                        <a class="mobile-nav-toggle" data-bs-toggle="collapse" href="#mobileUpgrading">
                            <i class="bi bi-chevron-right me-1"></i><i class="bi bi-arrow-up-circle me-2"></i>Upgrading
                        </a>
                        <div class="collapse" id="mobileUpgrading">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/upgrading#migration-wizard' | relative_url }}">Migration Wizard</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/upgrading#what-gets-migrated' | relative_url }}">What Gets Migrated</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/upgrading#important-notes' | relative_url }}">Important Notes</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Troubleshooting -->
                    <div class="mobile-nav-section">
                        <a class="mobile-nav-toggle" data-bs-toggle="collapse" href="#mobileTroubleshooting">
                            <i class="bi bi-chevron-right me-1"></i><i class="bi bi-question-circle me-2"></i>Troubleshooting
                        </a>
                        <div class="collapse" id="mobileTroubleshooting">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/troubleshooting#tabs-not-appearing-in-salesforce' | relative_url }}">Tabs Not Appearing</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/troubleshooting#tab-links-not-working' | relative_url }}">Tab Links Not Working</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/troubleshooting#settings-not-saving' | relative_url }}">Settings Not Saving</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/troubleshooting#still-having-issues' | relative_url }}">Still Having Issues?</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar (only on documentation pages) -->
            {% if page.url != '/' %}
            <aside class="col-lg-3 col-xl-2 d-none d-lg-block sidebar">
                <div class="sidebar-sticky">
                    <!-- Sticky Header -->
                    <div class="sidebar-header">
                        <h6 class="sidebar-heading">User Guide</h6>

                        <!-- Search Bar -->
                        <div class="sidebar-search">
                            <div class="search-input-wrapper">
                                <i class="bi bi-search search-icon"></i>
                                <input type="text" id="sidebarSearch" class="form-control" placeholder="Search guide..." autocomplete="off">
                                <button id="clearSearch" class="clear-search" style="display: none;">
                                    <i class="bi bi-x-circle-fill"></i>
                                </button>
                            </div>
                            <div id="searchSuggestions" class="search-suggestions" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Scrollable Sections -->
                    <div class="sidebar-sections">
                        <!-- Getting Started -->
                        <div class="sidebar-section">
                            <a class="sidebar-toggle" data-bs-toggle="collapse" href="#gettingStarted">
                                <i class="bi bi-chevron-right me-1"></i><i class="bi bi-rocket-takeoff me-2"></i>Getting Started
                            </a>
                            <div class="collapse" id="gettingStarted">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/getting-started#opening-the-extension' | relative_url }}">Opening the Extension</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/getting-started#adding-a-new-tab' | relative_url }}">Adding a New Tab</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/getting-started#tab-types' | relative_url }}">Tab Types</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                        <!-- Managing Tabs -->
                        <div class="sidebar-section">
                            <a class="sidebar-toggle" data-bs-toggle="collapse" href="#managingTabs">
                                <i class="bi bi-chevron-right me-1"></i><i class="bi bi-pencil-square me-2"></i>Managing Tabs
                            </a>
                            <div class="collapse" id="managingTabs">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#editing-tabs' | relative_url }}">Editing Tabs</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#reordering-tabs' | relative_url }}">Reordering Tabs</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#open-in-new-tab' | relative_url }}">Open in New Tab</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#deleting-tabs' | relative_url }}">Deleting Tabs</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#creating-dropdown-menus' | relative_url }}">Creating Dropdown Menus</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ '/managing-tabs#floating-button' | relative_url }}">Floating Button</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                        <!-- Keyboard Shortcuts -->
                        <div class="sidebar-section">
                            <a class="sidebar-toggle" data-bs-toggle="collapse" href="#keyboardShortcuts">
                                <i class="bi bi-chevron-right me-1"></i><i class="bi bi-keyboard me-2"></i>Keyboard Shortcuts
                            </a>
                            <div class="collapse" id="keyboardShortcuts">
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/keyboard-shortcuts#setting-up-shortcuts-in-firefox' | relative_url }}">Setting Up Shortcuts in Firefox</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/keyboard-shortcuts#setting-up-shortcuts-in-chrome' | relative_url }}">Setting Up Shortcuts in Chrome</a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="sidebar-section">
                            <a class="sidebar-toggle" data-bs-toggle="collapse" href="#settings">
                                <i class="bi bi-chevron-right me-1"></i><i class="bi bi-gear me-2"></i>Settings
                            </a>
                            <div class="collapse" id="settings">
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/settings#general' | relative_url }}">General</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/settings#floating-button' | relative_url }}">Floating Button</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/settings#profiles' | relative_url }}">Profiles</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/settings#keyboard-shortcuts' | relative_url }}">Keyboard Shortcuts</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/settings#data' | relative_url }}">Data</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/settings#importexport-configuration' | relative_url }}">Import/Export Configuration</a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Profiles -->
                        <div class="sidebar-section">
                            <a class="sidebar-toggle" data-bs-toggle="collapse" href="#profiles">
                                <i class="bi bi-chevron-right me-1"></i><i class="bi bi-person-circle me-2"></i>Profiles
                            </a>
                            <div class="collapse" id="profiles">
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/profiles#creating-a-new-profile' | relative_url }}">Creating a New Profile</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/profiles#managing-profiles' | relative_url }}">Managing Profiles</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/profiles#profile-best-practices' | relative_url }}">Profile Best Practices</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/profiles#disabling-profiles' | relative_url }}">Disabling Profiles</a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Upgrading -->
                        <div class="sidebar-section">
                            <a class="sidebar-toggle" data-bs-toggle="collapse" href="#upgrading">
                                <i class="bi bi-chevron-right me-1"></i><i class="bi bi-arrow-up-circle me-2"></i>Upgrading to v2.0
                            </a>
                            <div class="collapse" id="upgrading">
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/upgrading#whats-being-migrated' | relative_url }}">What's Being Migrated?</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/upgrading#migration-wizard-screens' | relative_url }}">Migration Wizard Screens</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/upgrading#what-if-migration-fails' | relative_url }}">What If Migration Fails?</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/upgrading#after-migration' | relative_url }}">After Migration</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/upgrading#can-i-revert-after-migration' | relative_url }}">Can I Revert After Migration?</a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Troubleshooting -->
                        <div class="sidebar-section">
                            <a class="sidebar-toggle" data-bs-toggle="collapse" href="#troubleshooting">
                                <i class="bi bi-chevron-right me-1"></i><i class="bi bi-wrench me-2"></i>Troubleshooting
                            </a>
                            <div class="collapse" id="troubleshooting">
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/troubleshooting#tabs-not-appearing-in-salesforce' | relative_url }}">Tabs not appearing in Salesforce</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/troubleshooting#tab-links-not-working' | relative_url }}">Tab links not working</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/troubleshooting#settings-not-saving' | relative_url }}">Settings not saving</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ '/troubleshooting#still-having-issues' | relative_url }}">Still having issues?</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
            {% endif %}

            <!-- Main content area -->
            <main class="{% if page.url != '/' %}col-lg-9 col-xl-10 ms-sm-auto{% else %}col-12{% endif %} px-md-4 main-content">
                <div class="content-wrapper">
                    {{ content }}
                </div>

                <!-- Footer -->
                <footer class="footer mt-5 py-4">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="text-muted mb-0">
                                    Â© {{ 'now' | date: "%Y" }} SF Tabs. Open source project.
                                </p>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <a href="https://github.com/chrisrouse/sftabs" class="text-muted text-decoration-none me-3" target="_blank">
                                    <i class="bi bi-github"></i> GitHub
                                </a>
                                <a href="https://github.com/chrisrouse/sftabs/issues" class="text-muted text-decoration-none" target="_blank">
                                    <i class="bi bi-bug"></i> Issues
                                </a>
                            </div>
                        </div>
                    </div>
                </footer>
            </main>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

    <!-- Sidebar collapse toggle -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Restore sidebar section states from localStorage
            const savedStates = JSON.parse(localStorage.getItem('sidebarStates') || '{}');

            // Handle sidebar toggle chevron icons and persistence
            const toggles = document.querySelectorAll('.sidebar-toggle');
            toggles.forEach(toggle => {
                const target = toggle.getAttribute('href');
                const collapseElement = document.querySelector(target);

                if (collapseElement) {
                    // Restore saved state
                    const sectionId = target.replace('#', '');
                    if (savedStates[sectionId] === true) {
                        collapseElement.classList.add('show');
                        const icon = toggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('bi-chevron-right');
                            icon.classList.add('bi-chevron-down');
                        }
                    }

                    collapseElement.addEventListener('show.bs.collapse', function() {
                        const icon = toggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('bi-chevron-right');
                            icon.classList.add('bi-chevron-down');
                        }
                        // Save state to localStorage
                        const sectionId = target.replace('#', '');
                        const states = JSON.parse(localStorage.getItem('sidebarStates') || '{}');
                        states[sectionId] = true;
                        localStorage.setItem('sidebarStates', JSON.stringify(states));
                    });

                    collapseElement.addEventListener('hide.bs.collapse', function() {
                        const icon = toggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('bi-chevron-down');
                            icon.classList.add('bi-chevron-right');
                        }
                        // Save state to localStorage
                        const sectionId = target.replace('#', '');
                        const states = JSON.parse(localStorage.getItem('sidebarStates') || '{}');
                        states[sectionId] = false;
                        localStorage.setItem('sidebarStates', JSON.stringify(states));
                    });
                }
            });

            // Search functionality
            const searchInput = document.getElementById('sidebarSearch');
            const clearButton = document.getElementById('clearSearch');
            const suggestionsContainer = document.getElementById('searchSuggestions');
            const sidebarSections = document.querySelectorAll('.sidebar-section');
            const contentWrapper = document.querySelector('.content-wrapper');

            if (!searchInput) return;

            let searchTimeout;
            let contentIndex = [];

            // Build search index from content
            function buildContentIndex() {
                if (!contentWrapper) return;

                const headings = contentWrapper.querySelectorAll('h2, h3, h4');
                headings.forEach(heading => {
                    const id = heading.id;
                    const text = heading.textContent.trim();
                    let preview = '';

                    // Get preview text from next elements
                    let nextElement = heading.nextElementSibling;
                    while (nextElement && preview.length < 150) {
                        if (nextElement.tagName.match(/^H[2-6]$/)) break;
                        if (nextElement.textContent) {
                            preview += nextElement.textContent.trim() + ' ';
                        }
                        nextElement = nextElement.nextElementSibling;
                    }

                    contentIndex.push({
                        id: id,
                        title: text,
                        preview: preview.substring(0, 150).trim() + '...',
                        element: heading
                    });
                });
            }

            buildContentIndex();

            // Debounce function
            function debounce(func, wait) {
                return function executedFunction(...args) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => func(...args), wait);
                };
            }

            // Highlight text matches
            function highlightText(text, query) {
                if (!query) return text;
                const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
                return text.replace(regex, '<span class="search-suggestion-highlight">$1</span>');
            }

            // Escape regex special characters
            function escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // Filter sidebar TOC
            function filterSidebar(query) {
                if (!query) {
                    sidebarSections.forEach(section => {
                        section.classList.remove('search-hidden');
                    });
                    return;
                }

                const lowerQuery = query.toLowerCase();
                sidebarSections.forEach(section => {
                    const toggleText = section.querySelector('.sidebar-toggle')?.textContent.toLowerCase() || '';
                    const links = section.querySelectorAll('.nav-link');
                    let hasMatch = toggleText.includes(lowerQuery);

                    links.forEach(link => {
                        const linkText = link.textContent.toLowerCase();
                        if (linkText.includes(lowerQuery)) {
                            hasMatch = true;
                        }
                    });

                    if (hasMatch) {
                        section.classList.remove('search-hidden');
                        // Expand matching sections
                        const collapse = section.querySelector('.collapse');
                        if (collapse && !collapse.classList.contains('show')) {
                            const bsCollapse = new bootstrap.Collapse(collapse, { toggle: true });
                        }
                    } else {
                        section.classList.add('search-hidden');
                    }
                });
            }

            // Show search suggestions
            function showSuggestions(query) {
                if (!query || query.length < 2) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                const lowerQuery = query.toLowerCase();
                const matches = contentIndex.filter(item =>
                    item.title.toLowerCase().includes(lowerQuery) ||
                    item.preview.toLowerCase().includes(lowerQuery)
                ).slice(0, 8); // Limit to 8 suggestions

                if (matches.length === 0) {
                    suggestionsContainer.innerHTML = '<div class="no-results">No results found</div>';
                    suggestionsContainer.style.display = 'block';
                    return;
                }

                const html = matches.map(item => `
                    <div class="search-suggestion-item" data-id="${item.id}">
                        <div class="search-suggestion-title">${highlightText(item.title, query)}</div>
                        <div class="search-suggestion-preview">${highlightText(item.preview, query)}</div>
                    </div>
                `).join('');

                suggestionsContainer.innerHTML = html;
                suggestionsContainer.style.display = 'block';

                // Add click handlers
                suggestionsContainer.querySelectorAll('.search-suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        if (id) {
                            window.location.hash = id;
                            searchInput.value = '';
                            clearSearch();
                        }
                    });
                });
            }

            // Handle search input
            const handleSearch = debounce(function(e) {
                const query = e.target.value.trim();

                if (query) {
                    clearButton.style.display = 'block';
                } else {
                    clearButton.style.display = 'none';
                }

                filterSidebar(query);
                showSuggestions(query);
            }, 300);

            searchInput.addEventListener('input', handleSearch);

            // Clear search
            function clearSearch() {
                searchInput.value = '';
                clearButton.style.display = 'none';
                suggestionsContainer.style.display = 'none';
                filterSidebar('');
            }

            clearButton.addEventListener('click', clearSearch);

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });

            // Handle escape key
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    clearSearch();
                }
            });

            // Mobile Navigation Functionality
            const mobileToggles = document.querySelectorAll('.mobile-nav-toggle');
            const mobileSavedStates = JSON.parse(localStorage.getItem('mobileSidebarStates') || '{}');

            // Handle mobile navigation toggle chevron icons and persistence
            mobileToggles.forEach(toggle => {
                const target = toggle.getAttribute('href');
                const collapseElement = document.querySelector(target);

                if (collapseElement) {
                    // Restore saved state
                    const sectionId = target.replace('#', '');
                    if (mobileSavedStates[sectionId] === true) {
                        collapseElement.classList.add('show');
                        const icon = toggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('bi-chevron-right');
                            icon.classList.add('bi-chevron-down');
                        }
                    }

                    collapseElement.addEventListener('show.bs.collapse', function() {
                        const icon = toggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('bi-chevron-right');
                            icon.classList.add('bi-chevron-down');
                        }
                        // Save state to localStorage
                        const sectionId = target.replace('#', '');
                        const states = JSON.parse(localStorage.getItem('mobileSidebarStates') || '{}');
                        states[sectionId] = true;
                        localStorage.setItem('mobileSidebarStates', JSON.stringify(states));
                    });

                    collapseElement.addEventListener('hide.bs.collapse', function() {
                        const icon = toggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('bi-chevron-down');
                            icon.classList.add('bi-chevron-right');
                        }
                        // Save state to localStorage
                        const sectionId = target.replace('#', '');
                        const states = JSON.parse(localStorage.getItem('mobileSidebarStates') || '{}');
                        states[sectionId] = false;
                        localStorage.setItem('mobileSidebarStates', JSON.stringify(states));
                    });
                }
            });

            // Mobile Search Functionality
            const mobileSearchInput = document.getElementById('mobileSidebarSearch');
            const mobileClearButton = document.getElementById('mobileClearSearch');
            const mobileSuggestionsContainer = document.getElementById('mobileSearchSuggestions');
            const mobileNavSections = document.querySelectorAll('.mobile-nav-section');

            if (mobileSearchInput) {
                // Filter mobile sidebar
                function filterMobileSidebar(query) {
                    const lowerQuery = query.toLowerCase();

                    mobileNavSections.forEach(section => {
                        const toggle = section.querySelector('.mobile-nav-toggle');
                        const links = section.querySelectorAll('.nav-link');
                        let hasMatch = false;

                        // Check if section title matches
                        if (toggle && toggle.textContent.toLowerCase().includes(lowerQuery)) {
                            hasMatch = true;
                        }

                        // Check if any links match
                        links.forEach(link => {
                            if (link.textContent.toLowerCase().includes(lowerQuery)) {
                                hasMatch = true;
                            }
                        });

                        if (query && hasMatch) {
                            section.classList.remove('search-hidden');
                            // Auto-expand sections with matches
                            const collapseElement = section.querySelector('.collapse');
                            if (collapseElement && !collapseElement.classList.contains('show')) {
                                collapseElement.classList.add('show');
                            }
                        } else if (query) {
                            section.classList.add('search-hidden');
                        } else {
                            section.classList.remove('search-hidden');
                        }
                    });
                }

                // Show mobile search suggestions
                function showMobileSuggestions(query) {
                    if (!query || query.length < 2) {
                        mobileSuggestionsContainer.style.display = 'none';
                        return;
                    }

                    const lowerQuery = query.toLowerCase();
                    const matches = contentIndex.filter(item =>
                        item.title.toLowerCase().includes(lowerQuery) ||
                        item.preview.toLowerCase().includes(lowerQuery)
                    ).slice(0, 8);

                    if (matches.length === 0) {
                        mobileSuggestionsContainer.innerHTML = '<div class="no-results">No results found</div>';
                        mobileSuggestionsContainer.style.display = 'block';
                        return;
                    }

                    const html = matches.map(item => `
                        <div class="search-suggestion-item" data-id="${item.id}">
                            <div class="search-suggestion-title">${highlightText(item.title, query)}</div>
                            <div class="search-suggestion-preview">${highlightText(item.preview, query)}</div>
                        </div>
                    `).join('');

                    mobileSuggestionsContainer.innerHTML = html;
                    mobileSuggestionsContainer.style.display = 'block';

                    // Add click handlers
                    mobileSuggestionsContainer.querySelectorAll('.search-suggestion-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            if (id) {
                                window.location.hash = id;
                                mobileSearchInput.value = '';
                                clearMobileSearch();
                            }
                        });
                    });
                }

                // Handle mobile search input
                const handleMobileSearch = debounce(function(e) {
                    const query = e.target.value.trim();

                    if (query) {
                        mobileClearButton.style.display = 'block';
                    } else {
                        mobileClearButton.style.display = 'none';
                    }

                    filterMobileSidebar(query);
                    showMobileSuggestions(query);
                }, 300);

                mobileSearchInput.addEventListener('input', handleMobileSearch);

                // Clear mobile search
                function clearMobileSearch() {
                    mobileSearchInput.value = '';
                    mobileClearButton.style.display = 'none';
                    mobileSuggestionsContainer.style.display = 'none';
                    filterMobileSidebar('');
                }

                mobileClearButton.addEventListener('click', clearMobileSearch);

                // Close mobile suggestions when clicking outside
                document.addEventListener('click', function(e) {
                    if (!mobileSearchInput.contains(e.target) && !mobileSuggestionsContainer.contains(e.target)) {
                        mobileSuggestionsContainer.style.display = 'none';
                    }
                });

                // Handle escape key for mobile
                mobileSearchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        clearMobileSearch();
                    }
                });
            }
        });
    </script>
</body>
</html>
